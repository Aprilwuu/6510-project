---
title: "DASC 6510 Project Models"
author: "Alisa Dmitrieva"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
### April's portion ###

# load data and packages
library(dplyr)
library(ggplot2)
library(agridat)


data("chakravertti.factorial")
df <- chakravertti.factorial
str(df)

df <- df %>%
  mutate(
    date    = factor(date,    levels = c("A01","A16","J16","S01","S16")),
    variety = factor(gen,     levels = c("Bhasakalma","Bhasamanik","Nehara")),
    spacing = factor(spacing, levels = c(6, 9, 12)),
    seed    = factor(seeds,   levels = c("1","2","local")),
    block   = factor(block)
  )

# summary statistics
summary(df$yield)
df %>% group_by(date) %>% summarise(mean_yield = mean(yield))
df %>% group_by(variety) %>% summarise(mean_yield = mean(yield))
df %>% group_by(spacing) %>% summarise(mean_yield = mean(yield))
df %>% group_by(seed) %>% summarise(mean_yield = mean(yield))

# Box plots for single factor
# main plot factor-planting date
ggplot(df, aes(date, yield)) +
  geom_boxplot(fill="skyblue") +
  labs(
    title="Yield by Planting Date", 
    x = "Planting Date",
    y = "Yield"
  ) +
  theme_bw()

# subplot factor-rice genotype
ggplot(df, aes(variety, yield)) +
  geom_boxplot(fill="lightgreen") +
  labs(
    title="Yield by Variety", 
    x = "Variety",
    y = "Yield"
  ) +
  theme_bw()

# sub-subplot factor-plant spacing
ggplot(df, aes(spacing, yield)) +
  geom_boxplot(fill="orange") +
  labs(
    title = "Yield by Plant Spacing",
    x = "Spacing",
    y = "Yield"
  ) +
  theme_bw()

# sub-subplot factor-seedlings per hill
ggplot(df, aes(seed, yield)) +
  geom_boxplot(fill="pink") +
  labs(
    title = "Yield by Seedlings per Hill", 
    x = "Seedlings per Hill",
    y = "Yield"
  ) +
  theme_bw()

# Interaction Plots

# dates * genotype
cols <- c("red", "darkgreen", "black")
ltys <- c(1, 2, 3)
pchs <- c(16, 16, 16)

interaction.plot(
  x.factor     = df$date,
  trace.factor = df$variety,
  response     = df$yield,
  type = "b",
  lwd = 2,
  col = cols,
  lty = ltys,
  pch = pchs,
  xlab = "Planting Date",
  ylab = "Mean Yield",
  main = "Interaction: Planting Date × Variety",
  legend = FALSE
)

legend("topright", 
       legend=levels(df$variety), col=cols, lty=ltys, lwd=2, pch=pchs, title="Variety", bty="n",cex=0.8)


# genotype * spacing
interaction.plot(
  x.factor     = df$variety,    # x-axis: rice variety
  trace.factor = df$spacing,    # trace: spacing levels (6, 9, 12)
  response     = df$yield,      # response variable: yield
  type  = "b",                  # “b” = both lines and points
  lwd   = 2,                    # line width
  col   = cols,                # colors for each spacing level
  lty   = ltys,                 # line types
  pch   = pchs,                 # point shape
  xlab  = "Variety",            # x-axis label
  ylab  = "Mean Yield",         # y-axis label
  main  = "Interaction: Variety × Spacing",  # title
  legend = FALSE                # disable the default legend
)

# Add a custom legend (placed in the top-right corner)
legend(
  "topright",
  legend = levels(df$spacing),  # spacing levels (e.g., "6", "9", "12")
  col    = cols,
  lty    = ltys,
  lwd    = 2,
  pch    = pchs,
  title  = "Spacing (inches)",  # legend title
  bty    = "n",                 # no box border
  cex    = 0.8                  # reduce text size
)


# spacing * seedlings

# Base interaction plot (legend disabled for manual control)
interaction.plot(
  x.factor     = df$spacing,   # x-axis: spacing (inches)
  trace.factor = df$seed,      # trace lines: number of seedlings per hill
  response     = df$yield,     # response variable: yield
  type  = "b",
  lwd   = 2,
  col   = cols,
  lty   = ltys,
  pch   = pchs,
  xlab  = "Plant Spacing (inches)",
  ylab  = "Mean Yield",
  main  = "Interaction: Spacing × Seedlings",
  legend = FALSE
)

# Add a custom legend
legend(
  "topright",
  legend = levels(df$seed),   # seed levels: "1", "2", "local"
  col    = cols,
  lty    = ltys,
  lwd    = 2,
  pch    = pchs,
  title  = "Seedlings per Hill",
  bty    = "n",
  cex    = 0.8                # slightly smaller legend text
)

# block statistic summary
df %>% group_by(block) %>% summarise(mean_yield = mean(yield))

ggplot(df, aes(block, yield)) +
  geom_boxplot(fill = "lightgray") +
  labs(title = "Yield by Block", x = "Block", y = "Yield") +
  theme_bw()
```

### Split-Split-Plot ANOVA

The experiment was conducted using three blocks to control for field variability. Treatments were randomized within each block following a split–split-plot design.

The structure of the experimental design was as follows:

-   Main plot factor: Planting date (5 levels: July 16, August 1, August 16, September 1, September 16)

-   Subplot factor: Rice genotype (3 varieties: Nehara, Bhasamanik, Bhasakalma)

-   Sub-subplot factors: Plant spacing (6 in, 9 in, 12 in) and number of seedlings per hill (1, 2, and local method)

It was determined that a split-split-plot ANOVA model should be fitted to the data, as a standard ANOVA model might not be adequate. The *lmer* function from the *lme4* package will be used to fit the model.

```{r}
# Loading the lme4 package
library(lmerTest) 

## Fitting the mixed-effects model ##
  # Fixed effects include all factors and their interactions. 
  # Random effects capture the appropriate 
    # error structures for each plot size.
splitSplitAnova_fit <- lmer(yield ~ date * variety * seed * spacing +
                              (1 | block) +
                              (1 | block:date) + 
                              (1 | block:date:variety),
                            data = df)
anova(splitSplitAnova_fit)

# Updating the model formula to remove the highest-order 
#   non-significant interaction term:
#     - date:variety:seed:spacing
splitSplitAnova2 <- update(splitSplitAnova_fit, .~. 
                 -date:variety:seed:spacing)
anova(splitSplitAnova2)

# Updating the model formula to remove non-significant  
#   3-way interaction terms:
#     - variety:seed:spacing
#     - date:seed:spacing
splitSplitAnova3 <- update(splitSplitAnova2, .~. 
                 -variety:seed:spacing
                 -date:seed:spacing)
anova(splitSplitAnova3)

# Updating the model formula to remove non-significant  
#   2-way interaction terms (while preserving hierarchy):
#     - seed:spacing
splitSplitAnova4 <- update(splitSplitAnova3, .~. 
                 -seed:spacing)
anova(splitSplitAnova4)
```

The final reduced model includes the following terms:

-   date

-   variety

-   seed

-   spacing

-   date:variety

-   date:seed

-   variety:seed

-   date:spacing

-   variety:spacing

-   date:variety:seed

-   date:variety:spacing

Note that the date:seed, variety:seed, and variety:spacing interactions were found to not be significant at $\alpha=0.05$. However, these terms were included in the model to preserve hierarchy.

```{r}
# The final reduced split-split-plot ANOVA model
splitSplitAnova_reduced <- splitSplitAnova4
anova(splitSplitAnova_reduced)

```

### Standard ANOVA

A standard ANOVA model for a factorial experimental design with blocking will also be fitted to the data as an alternative strategy. In this case, the blocking factor will be treated as an independent nuisance factor.

A key assumption for this model is that there is no interaction between the blocks and the treatment factors.

```{r}
# Fitting a standard factorial ANOVA model with blocking
factorialAnova_fit <- aov(yield ~ date * variety * seed * spacing + block, data=df)
summary(factorialAnova_fit)

# Updating the model formula to remove the highest-order 
#   non-significant interaction term:
#     - date:variety:seed:spacing
factorialAnova2 <- update(factorialAnova_fit, .~. 
                 -date:variety:seed:spacing)
summary(factorialAnova2)

# Updating the model formula to remove all non-significant
#   3-way interaction terms:
#     - variety:seed:spacing
#     - date:seed:spacing
#     - date:variety:spacing
factorialAnova3 <- update(factorialAnova2, .~. 
                 -variety:seed:spacing
                 -date:seed:spacing
                 -date:variety:spacing)
summary(factorialAnova3)

# Updating the model formula to remove all non-significant
#   2-way interaction terms (while preserving hierarchy):
#     - seed:spacing
#     - variety:spacing
factorialAnova4 <- update(factorialAnova3, .~. 
                 -seed:spacing
                 -variety:spacing)
summary(factorialAnova4)

```

The final reduced model includes the following terms:

-   date

-   variety

-   seed

-   spacing

-   date:variety

-   date:seed

-   variety:seed

-   date:spacing

-   date:variety:seed

Note that the date:seed and variety:seed interactions were found to not be significant at $\alpha=0.05$. However, these terms were included in the model to preserve hierarchy.

```{r}
# The final reduced factorial ANOVA model with blocking 
factorialAnova_reduced <- factorialAnova4
summary(factorialAnova_reduced)
```

### Split-Split-Plot regression model with coefficients

```{r}
# Regression model (split-split-plot ANOVA) with coefficients
summary(splitSplitAnova_reduced)
```

